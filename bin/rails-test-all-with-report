#!/usr/bin/env bash
# Run all tests with retry and save errors to file
#
# Usage: bin/rails-test-all-with-report [output_file]
#
# Environment:
#   PARALLEL_WORKERS - Number of parallel workers (default: 1)
#   MINITEST_RETRY_COUNT - Number of retries for failed tests (default: 3)

set -uo pipefail

OUTPUT_FILE="${1:-tmp/test_errors_$(date +%Y%m%d_%H%M%S).txt}"
export PARALLEL_WORKERS="${PARALLEL_WORKERS:-1}"
export MINITEST_RETRY_COUNT="${MINITEST_RETRY_COUNT:-3}"

mkdir -p "$(dirname "$OUTPUT_FILE")"

{
    echo "=== Rails Test Report ==="
    echo "Date: $(date)"
    echo "Parallel Workers: $PARALLEL_WORKERS"
    echo "Retry Count: $MINITEST_RETRY_COUNT"
    echo "========================="
    echo ""
} | tee "$OUTPUT_FILE"

# Run tests and capture output
TEST_OUTPUT=$(mktemp)
trap "rm -f $TEST_OUTPUT" EXIT

echo "Running: bin/rails test:all"
echo ""

bin/rails test:all 2>&1 | tee "$TEST_OUTPUT"
TEST_EXIT_CODE=${PIPESTATUS[0]}

{
    echo ""
    echo "=== Test Results ==="
    echo ""
} | tee -a "$OUTPUT_FILE"

# Extract summary line
grep -E "^[0-9]+ runs," "$TEST_OUTPUT" | tail -1 | tee -a "$OUTPUT_FILE" || true

# Check if there were failures or errors
if [ $TEST_EXIT_CODE -ne 0 ]; then
    {
        echo ""
        echo "=== Failed Tests ==="
        echo ""
    } | tee -a "$OUTPUT_FILE"

    # Extract failure/error blocks with better parsing
    awk '
        /^[[:space:]]*(Failure|Error):$/ {
            capture = 1
            print ""
            next
        }
        /^bin\/rails test / {
            print
            print ""
            capture = 0
            next
        }
        capture { print }
    ' "$TEST_OUTPUT" | tee -a "$OUTPUT_FILE"

    {
        echo ""
        echo "=== Failed Test Commands ==="
    } | tee -a "$OUTPUT_FILE"
    grep "^bin/rails test " "$TEST_OUTPUT" | sort -u | tee -a "$OUTPUT_FILE" || true

    echo ""
    echo "❌ Tests failed. Errors saved to: $OUTPUT_FILE"
    exit 1
else
    {
        echo ""
        echo "✅ All tests passed!"
    } | tee -a "$OUTPUT_FILE"
    echo ""
    echo "Report saved to: $OUTPUT_FILE"
    exit 0
fi
